version: '3.4'

# This Compose file is expected to be used with the devnet-up.sh script.
# The volumes below mount the configs generated by the script into each
# service.

volumes:
  l1_data:
  op1_l2_data:
  op1_log:

networks:
  avalanchelocal:
    ipam:
      driver: default
      config:
        - subnet: 177.17.0.0/24

services:
  ##################################################################################################
  # OP stack 901
  #
  op1-l2:
    image: ghcr.io/anomalyfi/op-integration/l2:integration
    build:
      context: .
      dockerfile: Dockerfile.l2
    ports:
      - "$OP1_L2_RPC_PORT:8545"
      - "$OP1_L2_DEBUG_PORT:6060"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.22
    volumes:
      - "op1_l2_data:/db"
      - "${DEVNET_DIR}/genesis-l2.json:/genesis.json"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
    entrypoint:
      # pass the L2 specific flags by overriding the entry-point and adding extra arguments
      - "/bin/sh"
      - "/entrypoint.sh"
      - "--authrpc.jwtsecret=/config/test-jwt-secret.txt"

  op1-node:
    image: ghcr.io/anomalyfi/op-integration/op-node:integration
    depends_on:
    #  - l1
      - op1-l2
    build:
      context: ../
      dockerfile: ./op-node/Dockerfile
    command: >
      op-node
      --l1=ws://l1:8546
      --l2=http://op1-l2:8551
      --l2.jwt-secret=/config/test-jwt-secret.txt
      --sequencer.enabled
      --sequencer.l1-confs=0
      --verifier.l1-confs=0
      --p2p.sequencer.key=8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
      --rollup.config=/rollup.json
      --rpc.addr=0.0.0.0
      --rpc.port=8545
      --p2p.listen.ip=0.0.0.0
      --p2p.listen.tcp=9003
      --p2p.listen.udp=9003
      --p2p.scoring.peers=light
      --p2p.ban.peers=true
      --snapshotlog.file=/op_log/snapshot.log
      --p2p.priv.path=/config/p2p-node-key.txt
      --metrics.enabled
      --metrics.addr=0.0.0.0
      --metrics.port=7300
      --pprof.enabled
      --rpc.enable-admin
     # --da-rpc=http://da:26658
     # --namespace-id=000008e5f679bf7116cb
     # --auth-token=$CELESTIA_NODE_AUTH_TOKEN
    ports:
      - "$OP1_NODE_RPC_PORT:8545"
      - "$OP1_NODE_P2P_PORT:9003"
      - "$OP1_NODE_METRICS_PORT:7300"
      - "$OP1_NODE_DEBUG_PORT:6060"
    # environment:
    #   - OP_NODE_NODEKIT_URL=http://sequencer0:8080
    #   - OP_NODE_AUTH_TOKEN=$CELESTIA_NODE_AUTH_TOKEN
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.21
    volumes:
      - "${PWD}/p2p-sequencer-key.txt:/config/p2p-sequencer-key.txt"
      - "${PWD}/p2p-node-key.txt:/config/p2p-node-key.txt"
      - "${PWD}/test-jwt-secret.txt:/config/test-jwt-secret.txt"
      - "${DEVNET_DIR}/rollup.json:/rollup.json"
      - op1_log:/op_log

  op1-proposer:
    image: ghcr.io/anomalyfi/op-integration/op-proposer:integration
    depends_on:
    #  - l1
      - op1-l2
      - op1-node
    build:
      context: ../
      dockerfile: ./op-proposer/Dockerfile
    ports:
      - "$OP1_PROPOSER_DEBUG_PORT:6060"
      - "$OP1_PROPOSER_METRICS_PORT:7300"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.20
    environment:
      OP_PROPOSER_L1_ETH_RPC: http://127.0.0.1:8545
      OP_PROPOSER_ROLLUP_RPC: http://op1-node:8545
      OP_PROPOSER_POLL_INTERVAL: 1s
      OP_PROPOSER_NUM_CONFIRMATIONS: 1
      OP_PROPOSER_MNEMONIC: test test test test test test test test test test test junk
      OP_PROPOSER_L2_OUTPUT_HD_PATH: "m/44'/60'/0'/0/1"
      OP_PROPOSER_L2OO_ADDRESS: "${L2OO_ADDRESS}"
      OP_PROPOSER_PPROF_ENABLED: "true"
      OP_PROPOSER_METRICS_ENABLED: "true"
      OP_PROPOSER_ALLOW_NON_FINALIZED: "true"
      #We have this as true and celestia has it as false
      OP_PROPOSER_NAMESPACE_ID: "000008e5f679bf7116cb"
      OP_PROPOSER_DA_RPC: http://da:26659

  op1-batcher:
    image: ghcr.io/anomalyfi/op-integration/op-batcher:integration
    depends_on:
      #- l1
      - op1-l2
      - op1-node
    build:
      context: ../
      dockerfile: ./op-batcher/Dockerfile
    ports:
      - "$OP1_BATCHER_DEBUG_PORT:6060"
      - "$OP1_BATCHER_METRICS_PORT:7300"
      - "$OP1_BATCHER_RPC_PORT:8545"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.19
    environment:
      OP_BATCHER_L1_ETH_RPC: http://127.0.0.1:8545
      OP_BATCHER_L2_ETH_RPC: http://op1-l2:8545
      OP_BATCHER_ROLLUP_RPC: http://op1-node:8545
      OP_BATCHER_MAX_CHANNEL_DURATION: 1
      OP_BATCHER_SUB_SAFETY_MARGIN: 4 # SWS is 15, ChannelTimeout is 40
      OP_BATCHER_POLL_INTERVAL: 1s
      OP_BATCHER_NUM_CONFIRMATIONS: 1
      OP_BATCHER_MNEMONIC: test test test test test test test test test test test junk
      OP_BATCHER_SEQUENCER_HD_PATH: "m/44'/60'/0'/0/2"
      OP_BATCHER_PPROF_ENABLED: "true"
      OP_BATCHER_METRICS_ENABLED: "true"
      OP_BATCHER_RPC_ENABLE_ADMIN: "true"
      #OP_BATCHER_NAMESPACE_ID: "000008e5f679bf7116cb"
     # OP_BATCHER_DA_RPC: http://da:26658
    #  OP_BATCHER_AUTH_TOKEN: $CELESTIA_NODE_AUTH_TOKEN
    # The batcher does not respond to sigint
    stop_grace_period: 1s

  op1-geth-proxy:
    image: ghcr.io/anomalyfi/op-integration/op-geth-proxy:integration
    build:
      context: ../
      dockerfile: ./op-geth-proxy/Dockerfile
    ports:
      - "$OP1_GETH_PROXY_PORT:9090"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.18
    environment:
      - OP_GETH_PROXY_GETH_ADDR=http://op1-l2:8545
      - OP_GETH_PROXY_LISTEN_ADDR=0.0.0.0:9090
      - OP_GETH_PROXY_VM_ID=$OP1_CHAIN_ID
    extra_hosts:
      - "host.docker.internal:host-gateway"

  artifact-server:
    # depends_on:
    #   - l1
    image: nginx:1.25-alpine
    ports:
      - "8080:80"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.17
    volumes:
      - "${DEVNET_DIR}/:/usr/share/nginx/html/:ro"
    security_opt:
      - "no-new-privileges:true"

  stateviz:
    image: ghcr.io/anomalyfi/op-integration/stateviz:integration
    build:
      context: ../
      dockerfile: ./ops-bedrock/Dockerfile.stateviz
    command:
      - stateviz
      - -addr=0.0.0.0:8080
      - -snapshot=/op_log/snapshot.log
      - -refresh=10s
    ports:
      - "9090:8080"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.16
    volumes:
      - op1_log:/op_log:ro

  avalanche-local-validator01:
    image: "ash/avalanche-node-local-validator01:${AVALANCHEGO_VERSION:-1.10.9}-${AVALANCHEGO_VM_NAME:-subnet-evm}-${AVALANCHEGO_VM_VERSION:-0.5.6}"
    container_name: ash-avalanche-local-validator01
    ports:
      - "9650:9650"
      - "9651:9651"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.11
    volumes:
      - ./data/conf/validator01/conf:/etc/avalanche/avalanchego/mounted-conf
  avalanche-local-validator02:
    image: "ash/avalanche-node-local-validator02:${AVALANCHEGO_VERSION:-1.10.9}-${AVALANCHEGO_VM_NAME:-subnet-evm}-${AVALANCHEGO_VM_VERSION:-0.5.6}"
    container_name: ash-avalanche-local-validator02
    ports:
      - "9652:9650"
      - "9653:9651"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.12
    volumes:
      - ./data/conf/validator02/conf:/etc/avalanche/avalanchego/mounted-conf
  avalanche-local-validator03:
    image: "ash/avalanche-node-local-validator03:${AVALANCHEGO_VERSION:-1.10.9}-${AVALANCHEGO_VM_NAME:-subnet-evm}-${AVALANCHEGO_VM_VERSION:-0.5.6}"
    container_name: ash-avalanche-local-validator03
    ports:
      - "9654:9650"
      - "9655:9651"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.13
    volumes:
      - ./data/conf/validator03/conf:/etc/avalanche/avalanchego/mounted-conf
  avalanche-local-validator04:
    image: "ash/avalanche-node-local-validator04:${AVALANCHEGO_VERSION:-1.10.9}-${AVALANCHEGO_VM_NAME:-subnet-evm}-${AVALANCHEGO_VM_VERSION:-0.5.6}"
    container_name: ash-avalanche-local-validator04
    ports:
      - "9656:9650"
      - "9657:9651"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.14
    volumes:
      - ./data/conf/validator04/conf:/etc/avalanche/avalanchego/mounted-conf
  avalanche-local-validator05:
    image: "ash/avalanche-node-local-validator05:${AVALANCHEGO_VERSION:-1.10.9}-${AVALANCHEGO_VM_NAME:-subnet-evm}-${AVALANCHEGO_VM_VERSION:-0.5.6}"
    container_name: ash-avalanche-local-validator05
    ports:
      - "9658:9650"
      - "9659:9651"
    networks:
      avalanchelocal:
        ipv4_address: 177.17.0.15
    volumes:
      - ./data/conf/validator05/conf:/etc/avalanche/avalanchego/mounted-conf


