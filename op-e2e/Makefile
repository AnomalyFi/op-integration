# Generally, JUNIT_FILE is set in CI but may be specified to an arbitrary file location to emulate CI locally
ifdef JUNIT_FILE
	go_test = OP_TESTLOG_DISABLE_COLOR=true OP_E2E_DISABLE_PARALLEL=false gotestsum --format=standard-verbose --junitfile=$(JUNIT_FILE) --
  # Note: -parallel must be set to match the number of cores in the resource class
	go_test_flags = -timeout=30m -parallel=8
else
	go_test = go test
	go_test_flags = -v
endif

# Not all the existing tests work in NodeKit mode. We have selectively enabled some here. To enable
# more once they start working, simply add to the -run flag below.
nodekit_test_flags = -l1-allocs ../.devnet-nodekit/allocs-l1.json \
	-l1-deployments ../.devnet-nodekit/addresses.json \
	-deploy-config ../packages/contracts-bedrock/deploy-config/devnetL1-nodekit.json \
	-parallel 1 \
	-run "TestMissingGasLimit|TestGethOnlyPendingBlockIsLatest|TestInvalidDepositInFCU|TestRegolith|TestPreregolith|TestSystemE2E|TestConfirmationDepth|TestMintOnRevertedDeposit|TestSystemP2PAltSync|TestSystemRPCAltSync|TestWithdrawals|TestERC20BridgeDeposits" \

test: pre-test test-legacy-ws test-nodekit-ws
.PHONY: test

test-external-%: pre-test
	make -C ./external_$*/
	$(go_test) $(go_test_flags) --externalL2 ./external_$*/

test-legacy-ws: pre-test
	$(go_test) $(go_test_flags) ./...
.PHONY: test-legacy-ws

test-legacy-http: pre-test
	OP_E2E_USE_HTTP=true $(go_test) $(go_test_flags) ./...
.PHONY: test-legacy-ws

test-nodekit-ws: pre-test
	$(go_test) $(go_test_flags) $(nodekit_test_flags) ./...
.PHONY: test-nodekit-ws

test-nodekit-http: pre-test
	OP_E2E_USE_HTTP=true $(go_test) $(go_test_flags) $(nodekit_test_flags) ./...
.PHONY: test-nodekit-ws

cannon-prestate:
	make -C .. cannon-prestate
.PHONY: cannon-prestate

# We depend on the absolute pre-state generated by cannon to deploy the dispute game contracts.
devnet-allocs: pre-test-cannon
	make -C .. devnet-allocs
.PHONY: devnet-allocs

devnet-allocs-nodekit: pre-test-cannon
	make -C .. devnet-allocs-nodekit
.PHONY: devnet-allocs-nodekit

pre-test: pre-test-cannon pre-test-allocs
.PHONY: pre-test

pre-test-cannon:
	@if [ ! -e ../op-program/bin ]; then \
		make cannon-prestate; \
	fi
.PHONY: pre-test-cannon

pre-test-allocs:
	@if [ ! -e ../.devnet ]; then \
		make devnet-allocs; \
	fi
	@if [ ! -e ../.devnet-nodekit ]; then \
		make devnet-allocs-nodekit; \
	fi
.PHONY: pre-test-allocs

clean:
	rm -r ../.devnet
	rm -r ../.devnet-nodekit
	rm -r ../op-program/bin
.PHONY: clean

lint:
	golangci-lint run -E goimports,sqlclosecheck,bodyclose,asciicheck,misspell,errorlint --timeout 5m -e "errors.As" -e "errors.Is" ./...
.PHONY: lint
